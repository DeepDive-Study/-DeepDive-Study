# 23. 실행 컨텍스트

자바스크립트의 동작 원리를 담고 있는 핵심 개념.

## 23.1 소스코드의 타입

ECMAScript 사양에서 4가지 타입으로 구분되는 소스코드는 실행 컨텍스트를 생성한다.

1. 전역 코드: 전역에 존재하는 소스코드. 전역 변수와 전역 함수를 전역 객체에 연결하기 위해 전역 코드가 평가되면 전역 실행 컨텍스트가 생성된다.
2. 함수 코드: 함수 내부에 존재하는 소스코드. 함수의 지역 스코프를 전역에서 시작하는 스코프 체인에 연결하기 위해 함수 코드가 평가되면 함수 실행 컨텍스트가 생성된다.
3. eval 코드: eval()에 인수로 전달되어 실행되는 소스코드. eval()은 strict mode에서 독자적인 스코프를 생성하는데, 이를 위해 eval 코드가 평가되면 eval 실행 컨텍스트가 생성된다.
4. 모듈 코드: 모듈 내부의 소스코드. 모듈 별로 독립적인 모듈 스코프를 생성하기 위해 모듈 코드가 평가되면 모듈 실행 컨텍스트가 생성된다.

## 23.2 소스코드의 평가와 실행

자바스크립트는 모든 소스코드를 '소스코드의 평가' → '소스코드의 실행' 과정으로 나누어 처리한다.

1. 소스코드의 평가: 실행 컨텍스트 생성 / 선언문 실행 및 스코프에 등록
2. 소스코드의 실행: 실행에 필요한 변수 및 함수의 참조 등의 정보를 실행 컨텍스트가 관리하는 스코프에서 취득한 후 실행한다. (값 변경 등 실행결과는 다시 스코프에 등록된다)

## 23.3 실행 컨텍스트의 역할

코드가 실행되면 스코프, 식별자, 코드 실행 순서 등의 관리가 필요하다. 이러한 환경을 제공하고 실행 결과를 관리하는 영역이 실행 컨텍스트이다.

식별자를 등록하고 관리하는 식별자와 코드 실행 순서 관리를 구현한 내부 매커니즘이다. 모든 코드는 실행 컨텍스트를 통해 실행되고 관리된다.

## 23.4 실행 컨텍스트 스택

코드 실행 순서는 실행 컨텍스트 스택으로 관리된다.

전역 코드 평가 → 전역 실행 컨텍스트 생성 → 함수 평가 → 함수 실행 컨텍스트 생성의 과정에서 생성된 실행 컨텍스트는 스택 자료구조로 관리되며 추가/제거된다.

## 23.5 렉시컬 환경

스코프와 식별자는 실행 컨텍스트의 렉시컬 환경으로 관리된다.

식별자에 바인딩된 값, 상위 스코프에 대한 참조를 기롷가는 자료구조로, key와 value 값을 갖는 객체 형태의 스코프를 생성하여 관리하는 저장소 역할을 한다. (렉시컬 스코프의 실체)

LexicalEnvironment 컴포넌트와 VariableEnvironment 컴포넌트로 구별된다.

(23.6, 23.7은 생략)

# 13. 스코프

## 13.1 스코프란?

스코프(scope, 유효범위)는 모든 프로그래밍 언어의 기본 개념이다.

모든 식별자(변수명, 함수명, 클래스명 등)은 자신이 선언된 위치에 의해 다른 코드가 식별자 자신을 참조할 수 있는 유효 범위가 결정되며, 이를 스코프라 한다.

```
var x = '글로벌';

function foo() {
	var x = '로컬';
	console.log(x);
}

foo();

console.log(x);
```

위 예제에서 같은 이름을 갖는 x 변수를 var로 선언했다. 자바스크립트 엔진은 코드의 문맥을 고려하기 때문에 스코프를 통해 어떤 변수를 참조해야 할 것인지를 정하게 된다.(식별자 결정) 따라서 '글로벌' 값을 가진 x 변수는 전역 스코프, '로컬' 값을 가진 x는 함수 스코프로 서로 다른 스코프를 가지기 때문에 별개의 변수로 취급된다.

즉, 스코프 내에서 식별자는 유일해야 하지만 다른 스코프에는 같은 이름의 식별자를 사용할 수 있다. (스코프 = 네임스페이스)

### 코드의 문맥과 환경

코드가 어디서 실행되며 주변에 어떤 코드가 있는지를 렉시컬 환경이라고 부른다. 코드의 문맥은 렉시컬 환경으로 이뤄지며 이를 구현한 것을 실행 컨텍스트라고 함.

## 13.2 스코프의 종류

### 전역과 전역 스코프

전역 스코프 - 전역 변수 - 코드의 가장 바깥 영역

어디서든지 참조할 수 있다.

### 지역과 지역 스코프

지역 스코프 - 지역 변수 - 함수 몸체 내부

자신의 지역 스코프와 하위 지역 스코프(중첩 함수)에서 유효하다.

## 13.3 스코프 체인

스코프가 계층적으로 연결된 것을 스코프 체인이라고 한다.

모든 스코프는 하나의 계층적 구조로 연결되며, 스코프는 함수의 중첩에 의해 계층적 구조를 갖는다. 모든 지역 스코프의 최상위 스코프는 전역 스코프이고 외부 함수의 지역 스코프를 중첩 함수의 상위 스코프라고 한다.

변수를 참조할 때 자바스크립트 엔진은 스코프 체인을 통해 변수를 참조하는 코드의 스코프에서 시작하여 상위 스코프 방향으로 이동하며 선언된 변수를 검색한다.

이 스코프 체인은 물리적 실체가 있다. 자바스크립트 엔진은 코드를 실행하기 전 렉시컬 환경이라는 자료구조를 만드는데, 변수 선언이 실행되면 변수 식별자가 key로 등록되고, 변수 할당이 일어나면 value를 변경하는 식이다. 변수의 검색은 이 자료구조 상에서 이뤄진다. 이 렉시컬 환경을 단방향으로 연결한 것이 스코프 체인이다. (상위 스코프 방향으로 이동하며 검색하므로 절대 상위 스코프에서 하위 스코프를 참조할 수 없음)

## 13.4 함수 레벨 스코프

대부분의 프로그래밍 언어는 함수 몸체뿐만이 아닌 모든 코드 블록(if, for 등)이 지역 스코프를 만들고, 이러한 특성을 블록 레벨 스코프라고 한다. 하지만 자바스크립트에서 var로 선언된 변수는 함수 몸체만을 지역 스코프로 인정하는데, 이러한 특성을 함수 레벨 스코프라고 한다.

```jsx
var i = 10;

for (var i = 0; i < 3; i++) {
  console.log(i); // 0 1 2
}

console.log(i); // 3
```

위 예제처럼 for문 안에서 선언한 i도 전역 변수가 된다. (var이므로 중복 선언됨)

ES6에서 도입된 let, const 키워드는 블록 레벨 스코프를 지원한다.

## 13.5 렉시컬 스코프

프로그래밍 언어는 두 가지 방식 중 하나로 함수의 상위 스코프를 결정한다.

- 동적 스코프 : 함수를 어디서 호출했는지에 따라 함수의 상위 스코프를 결정. (함수 호출 시점에 동적으로 상위 스코프 결정)
- 렉시컬 스코프(또는 정적 스코프) : 함수를 어디서 정의했는지에 따라 함수의 상위 스코프를 결정.

대부분의 언어가 그렇듯 자바스크립트는 렉시컬 스코프를 따르므로 함수가 호출된 위치는 상위 스코프 결정에 영향을 주지 않는다. 항상 자신이 정의된 스코프를 상위 스코프로 가진다.
